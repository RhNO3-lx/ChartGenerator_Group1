<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChartGalaxy - ä¿¡æ¯å›¾è¡¨ç”Ÿæˆå™¨</title>
    <style>
        #canvas {
            width: 100%;
            height: 600px;
            border: 1px dashed #ccc;
            position: relative;
            background: #ffffff;
            overflow-y: auto;   
            overflow-x: auto;   
        }

        /* åŒ…è£¹æ¯ä¸ªå¯æ“ä½œå›¾å½¢çš„å®¹å™¨ */
        .resizable {
            position: absolute;
            width: 200px;
            height: 200px;
            resize: both;
            overflow: hidden;
            border: 2px solid transparent;
            padding: 0;
            box-sizing: border-box;
            background: white;
            cursor: move;
        }

        /* æ˜¾ç¤ºé€‰ä¸­çŠ¶æ€ */
        .resizable.selected {
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
        }

        .resizable img, .resizable svg {
            width: 100%;
            height: 100%;
            object-fit: contain; /* ä¿æŒæ¯”ä¾‹ï¼Œä¸æ‹‰ä¼¸ */
            display: block;     /* é¿å…å†…è”å…ƒç´ çš„é»˜è®¤é—´éš™ */
        }
        .resizing {
            pointer-events: none; /* é˜²æ­¢é¼ æ ‡äº‹ä»¶ç©¿é€é€ æˆè¯¯æ‹–åŠ¨ */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            color: white;
        }

        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            padding: 25px;
        }

        .card-header {
            color: #764ba2;
            padding-bottom: 15px;
            font-size: 1.4rem;
            font-weight: bold;
            border-bottom: 2px solid #f0f0f0;
            margin-bottom: 20px;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 0.95rem;
        }

        .form-select, .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            transition: all 0.3s ease;
        }

        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-input[type="number"] {
            -moz-appearance: textfield;
        }

        .form-input[type="number"]::-webkit-outer-spin-button,

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            align-self: flex-end;
            height: 46px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        #svg-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            min-height: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 1px solid #e1e8ed;
            margin-top: 20px;
        }

        #svg-container svg {
            max-width: 100%;
            height: auto;
        }

        .loading {
            font-size: 1.1rem;
            color: #666;
            font-style: italic;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #e1e8ed;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: #e74c3c;
            font-weight: 600;
            text-align: center;
            padding: 15px;
            background: #fdecea;
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
        }

        @media (max-width: 768px) {
            .controls {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .btn-primary {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .card {
                padding: 15px;
            }
            
            .form-select, .form-input {
                padding: 10px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ChartGalaxy ä¿¡æ¯å›¾è¡¨ç”Ÿæˆå™¨</h1>
    </div>
    
    <div class="container">
        <div class="card">
            <div class="controls">
                <div class="control-group">
                    <label class="form-label">å­—ä½“</label>
                    <select class="form-select" id="fontSelector">
                        <option value="Arial">Arial</option>
                        <option value="Georgia">Georgia</option>
                        <option value="Times New Roman">Times New Roman</option>
                        <option value="Courier New">Courier New</option>
                        <option value="Verdana">Verdana</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label class="form-label">å­—å·</label>
                    <input class="form-input" type="number" id="fontSizeInput" value="16" min="8" max="72">
                </div>
            </div>
        </div>

        <button class="btn btn-primary" onclick="exportCanvasAsSVG()">å¯¼å‡ºå›¾è¡¨</button>
        
        <div id="svg-container">
            <div id="canvas">
                <!-- åŠ¨æ€æ’å…¥ SVGã€å›¾ç‰‡ç­‰å…ƒç´  -->
            </div>
        </div>
    </div>

    <!-- å¼•å…¥ Interact.js -->
<!-- <script src="/static/script/main/interact.min.js"></script> -->
<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
<script>
function applyFontSettings() {
    const font = document.getElementById('fontSelector').value;
    const size = document.getElementById('fontSizeInput').value + 'px';
    document.querySelectorAll('.editable-text').forEach(el => {
        el.style.fontFamily = font;
        el.style.fontSize = size;
    });
}

document.getElementById('fontSelector').addEventListener('change', applyFontSettings);
document.getElementById('fontSizeInput').addEventListener('input', applyFontSettings);

// ä½¿å…ƒç´ æ”¯æŒæ‹–åŠ¨ + ç­‰æ¯”ç¼©æ”¾
function enableInteract(el) {
    let isResizing = false;

    // æ‹–åŠ¨é€»è¾‘
    interact('.resizable').draggable({
        listeners: {
            move(event) {
                if (isResizing) return;  // è‹¥æ­£åœ¨ç¼©æ”¾ï¼Œåˆ™ä¸è§¦å‘æ‹–åŠ¨
                const target = event.target;
                const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
                const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
                target.style.transform = `translate(${x}px, ${y}px)`;
                target.setAttribute('data-x', x);
                target.setAttribute('data-y', y);
            }
        }
    });

    // ç¼©æ”¾é€»è¾‘
    let aspectRatio = 1;

    interact('.resizable').resizable({
        edges: { left: true, right: true, bottom: true, top: true },
        listeners: {
            start(event) {
                isResizing = true;
                event.target.classList.add('resizing');

                // è®°å½•åˆå§‹æ¯”ä¾‹
                const rect = event.target.getBoundingClientRect();
                aspectRatio = rect.width / rect.height;
            },
            move(event) {
                const target = event.target;

                // ç”¨ height æ¨å‡º widthï¼Œä¿æŒç­‰æ¯”
                const newHeight = event.rect.height;
                const newWidth = newHeight * aspectRatio;

                // è®¾ç½®å®¹å™¨å®½é«˜
                target.style.width = `${newWidth}px`;
                target.style.height = `${newHeight}px`;

                // åŒæ­¥ SVG æˆ–å›¾ç‰‡çš„å®½é«˜
                const content = target.querySelector('svg, img');
                if (content) {
                    content.style.width = `${newWidth}px`;
                    content.style.height = `${newHeight}px`;

                    if (content.tagName.toLowerCase() === 'svg') {
                        content.setAttribute('width', newWidth);
                        content.setAttribute('height', newHeight);
                    }
                }
            },
            end(event) {
                isResizing = false;
                event.target.classList.remove('resizing');
            }
        }
    });

    el.addEventListener('mousedown', () => {
        document.querySelectorAll('.resizable').forEach(div => {
                div.classList.remove('selected');
        });
        el.classList.add('selected');
    });
}

// æ’å…¥å›¾è¡¨æˆ–å›¾ç‰‡
function insertIntoCanvas(type, content, id) {
    const canvas = document.getElementById('canvas');
    const wrapper = document.createElement('div');
    wrapper.className = 'resizable';
    wrapper.setAttribute('id', id);
    wrapper.style.left = Math.random() * 200 + 'px';
    wrapper.style.top = Math.random() * 100 + 'px';
    wrapper.style.position = 'absolute'; // ç¡®ä¿å®šä½æ­£ç¡®
    wrapper.style.backgroundColor = 'transparent'; 

    if (type === 'svg') {
        wrapper.innerHTML = content;
        const maxSize = 1000; // æœ€å¤§å°ºå¯¸é™åˆ¶
        // ç­‰å¾… SVG æ¸²æŸ“åè·å–å…¶å°ºå¯¸
        setTimeout(() => {
            const svg = wrapper.querySelector('svg');
            if (svg) {
                // å¦‚æœ SVG æœ‰å›ºå®š width/heightï¼Œä½¿ç”¨å®ƒä»¬
                const svgWidth = svg.width.baseVal.value || svg.clientWidth;
                const svgHeight = svg.height.baseVal.value || svg.clientHeight;
                
                const scale = Math.min(maxSize / svgWidth, maxSize / svgHeight, 1); // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼Œä¸è¶…è¿‡1
                wrapper.style.width = `${svgWidth * scale}px`;
                wrapper.style.height = `${svgHeight * scale}px`;
                svg.setAttribute('viewBox', `0 0 ${svgWidth * scale} ${svgHeight * scale}`);
                // console.info(svg)
            }
        }, 0);

    } else {
        const img = document.createElement('img');
        img.src = content;
        const maxSize = 300; // æœ€å¤§å°ºå¯¸é™åˆ¶
        img.onload = () => {
            // å›¾ç‰‡åŠ è½½å®Œæˆåè®¾ç½®å®¹å™¨å°ºå¯¸
            const scale = Math.min(maxSize / img.naturalWidth, maxSize / img.naturalHeight, 1); // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼Œä¸è¶…è¿‡1
            wrapper.style.width = `${img.naturalWidth * scale}px`;
            wrapper.style.height = `${img.naturalHeight * scale}px`;
            console.info(scale)
            console.info(maxSize / img.naturalWidth)
            console.info(maxSize / img.naturalHeight)
        };
        wrapper.appendChild(img);
    }

    canvas.appendChild(wrapper);
    enableInteract(wrapper); // å¯ç”¨äº¤äº’
}


function getTranslatedPosition(el) {
    const rect = el.getBoundingClientRect();
    const parentRect = el.offsetParent?.getBoundingClientRect() || { left: 0, top: 0 };

    // è®¡ç®—ç›¸å¯¹ canvas çš„åç§»ä½ç½®ï¼ˆåŒ…æ‹¬ transformï¼‰
    return {
        x: rect.left - parentRect.left,
        y: rect.top - parentRect.top
    };
}


function loadIMG(chartType, data, title, pictogram) {
    const bg_color = "#f5f3ef"; // è®¾ç½®èƒŒæ™¯é¢œè‰²
    if (!chartType || !data) {
        alert("è¯·ç¡®ä¿å·²é€‰æ‹©æ•°æ®æºå’Œå›¾è¡¨ç±»å‹");
        return;
    }

    const canvas = document.getElementById('canvas');
    canvas.innerHTML = `<div class="loading"><div class="loading-spinner"></div><span>æ­£åœ¨åŠ è½½å›¾è¡¨...</span></div>`;

    const svgURL = `/authoring/chart?charttype=${encodeURIComponent(chartType)}&data=${encodeURIComponent(data)}&title=${encodeURIComponent(title)}&pictogram=${encodeURIComponent(pictogram)}`;

    fetch(svgURL)
        .then(res => {
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res.json();  // ğŸ‘ˆ æ”¹ä¸ºè§£æ JSON å“åº”
        })
        .then(response => {
            const { svg, img1, img2 } = response;

            canvas.innerHTML = '';
            insertIntoCanvas('svg', svg, 'svgChart');
            insertIntoCanvas('img', img1, 'img1');
            insertIntoCanvas('img', img2, 'img2');
            canvas.style.backgroundColor = bg_color;
        })
        .catch(err => {
            canvas.innerHTML = `<div class="error-message">åŠ è½½å›¾è¡¨å¤±è´¥: ${err.message}</div>`;
            console.error("åŠ è½½å›¾è¡¨å¤±è´¥:", err);
        });
}

function exportCanvasAsSVG() {
    const canvas = document.getElementById('canvas');
    const svgNS = "http://www.w3.org/2000/svg";
    const bg_color = "#f5f3ef"; // è®¾ç½®èƒŒæ™¯é¢œè‰²

    // è·å–æ‰€æœ‰ resizable å…ƒç´ çš„è¾¹ç•Œï¼Œç”¨äºç¡®å®š SVG å°ºå¯¸
    const resizables = canvas.querySelectorAll('.resizable');
    let maxRight = 0, maxBottom = 0;

    resizables.forEach(el => {
        const elRight = el.offsetLeft + el.offsetWidth;
        const elBottom = el.offsetTop + el.offsetHeight;
        if (elRight > maxRight) maxRight = elRight;
        if (elBottom > maxBottom) maxBottom = elBottom;
    });

    const svg = document.createElementNS(svgNS, "svg");
    svg.setAttribute("xmlns", svgNS);
    svg.setAttribute("width", maxRight);
    svg.setAttribute("height", maxBottom);
    svg.setAttribute("viewBox", `0 0 ${maxRight} ${maxBottom}`);

    // æ·»åŠ èƒŒæ™¯çŸ©å½¢ï¼Œå¡«å…… bg_color
    const backgroundRect = document.createElementNS(svgNS, "rect");
    backgroundRect.setAttribute("x", 0);
    backgroundRect.setAttribute("y", 0);
    backgroundRect.setAttribute("width", maxRight);
    backgroundRect.setAttribute("height", maxBottom);
    backgroundRect.setAttribute("fill", bg_color);  // èƒŒæ™¯é¢œè‰²
    svg.appendChild(backgroundRect);
    
    // éå†æ¯ä¸ªå…ƒç´ å¹¶å¤åˆ¶åˆ° SVG ä¸­
    resizables.forEach(el => {
        const { x: offsetX, y: offsetY } = getTranslatedPosition(el);

        const svgInner = el.querySelector('svg');
        if (svgInner) {
            const clone = svgInner.cloneNode(true);
            const wrapper = document.createElementNS(svgNS, "g");
            wrapper.setAttribute("transform", `translate(${offsetX}, ${offsetY})`);
            wrapper.appendChild(clone);
            svg.appendChild(wrapper);
        }

        const img = el.querySelector('img');
        if (img) {
            const imageEl = document.createElementNS(svgNS, "image");
            imageEl.setAttributeNS(null, 'href', img.src);
            imageEl.setAttribute('x', offsetX);
            imageEl.setAttribute('y', offsetY);
            imageEl.setAttribute('width', el.offsetWidth);
            imageEl.setAttribute('height', el.offsetHeight);
            svg.appendChild(imageEl);
        }

        // æ›´æ–°æœ€å¤§å®½é«˜ï¼ˆç”¨äº SVG å°ºå¯¸ï¼‰
        const right = offsetX + el.offsetWidth;
        const bottom = offsetY + el.offsetHeight;
        if (right > maxRight) maxRight = right;
        if (bottom > maxBottom) maxBottom = bottom;
    });

    // å¯¼å‡ºé€»è¾‘
    const serializer = new XMLSerializer();
    const svgStr = serializer.serializeToString(svg);
    const blob = new Blob([svgStr], { type: "image/svg+xml;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = "infographic.svg";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}


// åˆå§‹åŒ–åŠ è½½
window.addEventListener('DOMContentLoaded', () => {
    const initialChartType = "{{ charttype | safe }}";
    const initialData = "{{ data | safe }}";
    const initialTitle = "{{ title | safe }}";
    const initialPictogram= "{{ pictogram | safe }}";
    if (initialChartType && initialData) {
        loadIMG(initialChartType, initialData, initialTitle, initialPictogram);
    }
});

</script>


</body>
</html>