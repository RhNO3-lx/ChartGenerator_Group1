<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChartGalaxy - 信息图表生成器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            color: #333;
            padding: 30px 20px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="2" fill="white" opacity="0.1"/></svg>') repeat;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            animation: fadeInDown 0.6s ease-out;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #fff 0%, #f0f0f0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 4px 20px rgba(0,0,0,0.2);
            letter-spacing: -1px;
        }

        .header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            font-weight: 300;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
            animation: fadeIn 0.8s ease-out;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            color: #667eea;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #4a5568;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-select, .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            background: white;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-select:hover, .form-input:hover {
            border-color: #cbd5e0;
        }

        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .form-input[type="number"] {
            -moz-appearance: textfield;
        }

        .form-input[type="color"] {
            padding: 4px;
            height: 48px;
            cursor: pointer;
            border-radius: 12px;
        }

        .form-input[type="range"] {
            padding: 0;
            height: 8px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .form-input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: white;
            border: 3px solid #667eea;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
        }

        .form-input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .form-input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: white;
            border: 3px solid #667eea;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: inherit;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn i {
            position: relative;
            z-index: 1;
        }

        .btn span {
            position: relative;
            z-index: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(113, 128, 150, 0.2);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(113, 128, 150, 0.3);
        }

        .btn-secondary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: linear-gradient(135deg, #fc8181 0%, #e53e3e 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(252, 129, 129, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(252, 129, 129, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
        }

        .button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .button-grid-full {
            grid-column: 1 / -1;
        }

        .canvas-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        #canvas-container {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 16px;
            padding: 30px;
            min-height: 600px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
            border: 2px dashed rgba(102, 126, 234, 0.2);
            position: relative;
            overflow: auto;
        }

        #fabricCanvas {
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            border-radius: 8px;
        }

        .color-input-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .color-input-wrapper input[type="color"] {
            flex: 0 0 60px;
        }

        .color-input-wrapper input[type="text"] {
            flex: 1;
            text-transform: uppercase;
            font-weight: 600;
        }

        .loading {
            font-size: 1.2rem;
            color: #667eea;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(102, 126, 234, 0.2);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .error-message {
            color: #e53e3e;
            font-weight: 600;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
            border-radius: 12px;
            border-left: 4px solid #e53e3e;
            box-shadow: 0 4px 15px rgba(229, 62, 62, 0.2);
        }

        /* Refined image preview section */
        #refined-preview-section {
            display: none;
            animation: fadeIn 0.6s ease-out;
            margin-top: 30px;
        }

        #refined-preview-section.show {
            display: block;
        }

        .refined-preview-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .refined-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.2);
        }

        .refined-preview-header h3 {
            margin: 0;
            color: #2d3748;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .refined-preview-header h3 i {
            color: #667eea;
        }

        .refined-image-container {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
            border: 2px solid rgba(102, 126, 234, 0.1);
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 25px;
        }

        .comparison-item {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 2px solid rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
        }

        .comparison-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .comparison-item h4 {
            margin: 0 0 20px 0;
            color: #2d3748;
            font-size: 1.2rem;
            font-weight: 700;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .comparison-item h4 i {
            color: #667eea;
        }

        .comparison-item img {
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            transition: all 0.3s ease;
        }

        .comparison-item img:hover {
            transform: scale(1.02);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.16);
        }

        .refined-image-preview {
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .sidebar {
                order: 2;
            }

            .canvas-card {
                order: 1;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .button-grid {
                grid-template-columns: 1fr;
            }

            .comparison-grid {
                grid-template-columns: 1fr;
            }

            body {
                padding: 20px 10px;
            }

            .card, .canvas-card, .refined-preview-card {
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .card-title {
                font-size: 1rem;
            }

            .form-select, .form-input {
                padding: 10px 12px;
            }

            .btn {
                padding: 10px 16px;
                font-size: 0.9rem;
            }
        }

        /* Status badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(72, 187, 120, 0.3);
        }

        .status-badge i {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-chart-line"></i> ChartGalaxy</h1>
        <p>AI 驱动的信息图表生成器</p>
    </div>

    <div class="container">
        <div class="main-content">
            <!-- Sidebar with Controls -->
            <div class="sidebar">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-sliders-h"></i> 画布设置</h3>
                    <div class="control-group">
                        <label class="form-label"><i class="fas fa-expand-arrows-alt"></i> 画布比例</label>
                        <select class="form-select" id="aspectRatioSelector">
                            <option value="4:3">4:3 (横向)</option>
                            <option value="16:9">16:9 (宽屏)</option>
                            <option value="1:1">1:1 (正方形)</option>
                            <option value="3:4" selected>3:4 (纵向)</option>
                            <option value="9:16">9:16 (手机竖屏)</option>
                            <option value="2:1">2:1 (超宽)</option>
                            <option value="1:2">1:2 (超高)</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label class="form-label"><i class="fas fa-palette"></i> 背景颜色</label>
                        <div class="color-input-wrapper">
                            <input class="form-input" type="color" id="bgColorPicker" value="#f5f3ef">
                            <input class="form-input" type="text" id="bgColorText" value="#f5f3ef" maxlength="7" placeholder="#f5f3ef">
                        </div>
                    </div>

                    <div class="control-group">
                        <label class="form-label"><i class="fas fa-adjust"></i> 透明度: <span id="opacityValue">100</span>%</label>
                        <input class="form-input" type="range" id="opacitySlider" min="0" max="100" value="100" step="1">
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title"><i class="fas fa-tools"></i> 操作</h3>

                    <div class="button-grid">
                        <button class="btn btn-secondary" onclick="undo()" id="undoBtn">
                            <i class="fas fa-undo"></i> <span>撤销</span>
                        </button>
                        <button class="btn btn-secondary" onclick="redo()" id="redoBtn">
                            <i class="fas fa-redo"></i> <span>重做</span>
                        </button>
                        <button class="btn btn-secondary" onclick="bringToFront()">
                            <i class="fas fa-layer-group"></i> <span>置顶</span>
                        </button>
                        <button class="btn btn-secondary" onclick="sendToBack()">
                            <i class="fas fa-level-down-alt"></i> <span>置底</span>
                        </button>
                        <button class="btn btn-danger button-grid-full" onclick="deleteSelected()">
                            <i class="fas fa-trash-alt"></i> <span>删除选中</span>
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title"><i class="fas fa-download"></i> 导出</h3>

                    <div class="button-grid">
                        <button class="btn btn-primary" onclick="exportAsSVG()">
                            <i class="fas fa-file-code"></i> <span>SVG</span>
                        </button>
                        <button class="btn btn-primary" onclick="exportAsPNG()">
                            <i class="fas fa-file-image"></i> <span>PNG</span>
                        </button>
                        <button class="btn btn-success button-grid-full" onclick="generateRefinedVersion()">
                            <i class="fas fa-magic"></i> <span>生成 AI 精修版</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Canvas Area -->
            <div class="canvas-card">
                <div id="canvas-container">
                    <canvas id="fabricCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Refined image preview section (inline, below canvas) -->
    <div class="container" id="refined-preview-section">
        <div class="refined-preview-card">
            <div class="refined-preview-header">
                <h3><i class="fas fa-sparkles"></i> AI 精修版</h3>
                <button class="btn btn-success" onclick="downloadRefinedImage()">
                    <i class="fas fa-download"></i> <span>下载精修版</span>
                </button>
            </div>
            <div class="comparison-grid">
                <div class="comparison-item">
                    <h4><i class="fas fa-star"></i> 精修结果</h4>
                    <img id="refinedImagePreview" class="refined-image-preview" src="" alt="精修版图片">
                </div>
                <div class="comparison-item">
                    <h4><i class="fas fa-image"></i> 参考图表</h4>
                    <img id="referenceImagePreview" class="refined-image-preview" src="" alt="参考图表">
                </div>
            </div>
        </div>
    </div>

    <!-- 引入 Fabric.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script>
// 全局变量
let canvas;
let currentBgColor = '#ffffff';

// 撤销/重做历史记录
let undoStack = [];
let redoStack = [];
let isUndoRedoAction = false;

// 画布比例配置
const aspectRatios = {
    '4:3': { width: 800, height: 600 },
    '16:9': { width: 960, height: 540 },
    '1:1': { width: 700, height: 700 },
    '3:4': { width: 900, height: 1200 },
    '9:16': { width: 675, height: 1200 },
    '2:1': { width: 1000, height: 500 },
    '1:2': { width: 600, height: 1200 }
};

// 初始化 Fabric Canvas
function initCanvas(width, height) {
    canvas = new fabric.Canvas('fabricCanvas', {
        width: width,
        height: height,
        backgroundColor: currentBgColor,
        selection: true,
        preserveObjectStacking: true
    });

    // 设置选中样式
    fabric.Object.prototype.set({
        transparentCorners: false,
        cornerColor: '#667eea',
        cornerStrokeColor: '#667eea',
        borderColor: '#667eea',
        cornerSize: 10,
        padding: 5,
        cornerStyle: 'circle',
        borderScaleFactor: 2
    });

    // 键盘事件 - 删除选中对象
    document.addEventListener('keydown', function(e) {
        if ((e.key === 'Delete' || e.key === 'Backspace') && canvas.getActiveObject()) {
            deleteSelected();
        }
        // Ctrl+Z 撤销
        if (e.ctrlKey && e.key === 'z') {
            e.preventDefault();
            undo();
        }
        // Ctrl+Y 或 Ctrl+Shift+Z 重做
        if (e.ctrlKey && (e.key === 'y' || (e.shiftKey && e.key === 'z'))) {
            e.preventDefault();
            redo();
        }
    });

    // 监听画布变化，保存历史记录
    canvas.on('object:added', saveState);
    canvas.on('object:modified', saveState);
    canvas.on('object:removed', saveState);

    // 当选中对象时，更新透明度滑块的值
    canvas.on('selection:created', function(e) {
        updateOpacitySlider(e.selected[0]);
    });

    canvas.on('selection:updated', function(e) {
        updateOpacitySlider(e.selected[0]);
    });

    canvas.on('selection:cleared', function() {
        // 清除选择时，重置透明度滑块为100%
        document.getElementById('opacitySlider').value = 100;
        document.getElementById('opacityValue').textContent = '100';
    });
}

// 更新画布比例
function updateCanvasAspectRatio(ratio) {
    const config = aspectRatios[ratio] || aspectRatios['4:3'];

    canvas.setWidth(config.width);
    canvas.setHeight(config.height);
    canvas.renderAll();
}

// 更新背景颜色
function updateBgColor(color) {
    if (!/^#[0-9A-Fa-f]{6}$/.test(color)) {
        return;
    }

    currentBgColor = color;
    canvas.setBackgroundColor(color, canvas.renderAll.bind(canvas));

    // 同步两个输入控件
    document.getElementById('bgColorPicker').value = color;
    document.getElementById('bgColorText').value = color;
}

// 添加图片到画布
function addImageToCanvas(imageUrl, options = {}) {
    return new Promise((resolve, reject) => {
        fabric.Image.fromURL(imageUrl, function(img) {
            if (!img) {
                reject(new Error('Failed to load image'));
                return;
            }

            // 计算缩放比例，使图片适应画布
            const maxWidth = options.maxWidth || 300;
            const maxHeight = options.maxHeight || 300;
            const scale = Math.min(
                maxWidth / img.width,
                maxHeight / img.height,
                1
            );

            img.set({
                left: options.left || Math.random() * (canvas.width - img.width * scale),
                top: options.top || Math.random() * (canvas.height - img.height * scale),
                scaleX: scale,
                scaleY: scale,
                lockUniScaling: true  // 锁定等比缩放
            });

            canvas.add(img);
            canvas.renderAll();
            resolve(img);
        }, { crossOrigin: 'anonymous' });
    });
}

// 添加 SVG 到画布（使用图片方式加载以保证兼容性）
function addSVGToCanvas(svgString, options = {}) {
    return new Promise((resolve, reject) => {
        // 方法1: 尝试将 SVG 转换为 data URL 作为图片加载
        const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
        const svgUrl = URL.createObjectURL(svgBlob);

        fabric.Image.fromURL(svgUrl, function(img) {
            URL.revokeObjectURL(svgUrl);

            if (!img || !img.width || !img.height) {
                console.warn('Image load failed, trying SVG parse method...');
                // 回退到 SVG 解析方式
                addSVGToCanvasFallback(svgString, options).then(resolve).catch(reject);
                return;
            }

            // 计算缩放比例
            const maxWidth = options.maxWidth || canvas.width * 0.8;
            const maxHeight = options.maxHeight || canvas.height * 0.8;
            const scale = Math.min(
                maxWidth / img.width,
                maxHeight / img.height,
                1
            );

            img.set({
                left: options.left || (canvas.width - img.width * scale) / 2,
                top: options.top || (canvas.height - img.height * scale) / 2,
                scaleX: scale,
                scaleY: scale,
                lockUniScaling: true
            });

            canvas.add(img);
            canvas.renderAll();
            resolve(img);
        }, { crossOrigin: 'anonymous' });
    });
}

// SVG 解析方式（回退方案）
function addSVGToCanvasFallback(svgString, options = {}) {
    return new Promise((resolve, reject) => {
        fabric.loadSVGFromString(svgString, function(objects, svgOptions) {
            if (!objects || objects.length === 0) {
                reject(new Error('Failed to load SVG'));
                return;
            }

            const svgGroup = fabric.util.groupSVGElements(objects, svgOptions);

            // 计算缩放比例
            const maxWidth = options.maxWidth || canvas.width * 0.8;
            const maxHeight = options.maxHeight || canvas.height * 0.8;
            const scale = Math.min(
                maxWidth / svgGroup.width,
                maxHeight / svgGroup.height,
                1
            );

            svgGroup.set({
                left: options.left || (canvas.width - svgGroup.width * scale) / 2,
                top: options.top || (canvas.height - svgGroup.height * scale) / 2,
                scaleX: scale,
                scaleY: scale,
                lockUniScaling: true
            });

            canvas.add(svgGroup);
            canvas.renderAll();
            resolve(svgGroup);
        });
    });
}

// 保存画布状态到历史记录
function saveState() {
    if (isUndoRedoAction) {
        // 如果是撤销/重做操作触发的变化，不保存状态
        return;
    }

    // 保存当前画布状态
    const state = JSON.stringify(canvas.toJSON());
    undoStack.push(state);

    // 限制历史记录数量（最多50条）
    if (undoStack.length > 50) {
        undoStack.shift();
    }

    // 清空重做栈
    redoStack = [];

    // 更新按钮状态
    updateUndoRedoButtons();
}

// 撤销
function undo() {
    if (undoStack.length === 0) {
        return;
    }

    // 保存当前状态到重做栈
    const currentState = JSON.stringify(canvas.toJSON());
    redoStack.push(currentState);

    // 从撤销栈中取出上一个状态
    const previousState = undoStack.pop();

    // 标记为撤销操作，避免触发saveState
    isUndoRedoAction = true;

    // 恢复画布状态
    canvas.loadFromJSON(previousState, function() {
        canvas.renderAll();
        isUndoRedoAction = false;
        updateUndoRedoButtons();
    });
}

// 重做
function redo() {
    if (redoStack.length === 0) {
        return;
    }

    // 保存当前状态到撤销栈
    const currentState = JSON.stringify(canvas.toJSON());
    undoStack.push(currentState);

    // 从重做栈中取出状态
    const nextState = redoStack.pop();

    // 标记为重做操作，避免触发saveState
    isUndoRedoAction = true;

    // 恢复画布状态
    canvas.loadFromJSON(nextState, function() {
        canvas.renderAll();
        isUndoRedoAction = false;
        updateUndoRedoButtons();
    });
}

// 更新撤销/重做按钮状态
function updateUndoRedoButtons() {
    const undoBtn = document.getElementById('undoBtn');
    const redoBtn = document.getElementById('redoBtn');

    if (undoBtn) {
        undoBtn.disabled = undoStack.length === 0;
    }
    if (redoBtn) {
        redoBtn.disabled = redoStack.length === 0;
    }
}

// 删除选中对象
function deleteSelected() {
    const activeObjects = canvas.getActiveObjects();
    if (activeObjects.length > 0) {
        activeObjects.forEach(obj => canvas.remove(obj));
        canvas.discardActiveObject();
        canvas.renderAll();
    }
}

// 置于顶层
function bringToFront() {
    const activeObject = canvas.getActiveObject();
    if (activeObject) {
        canvas.bringToFront(activeObject);
        canvas.renderAll();
    }
}

// 置于底层
function sendToBack() {
    const activeObject = canvas.getActiveObject();
    if (activeObject) {
        canvas.sendToBack(activeObject);
        canvas.renderAll();
    }
}

// 导出为 SVG
function exportAsSVG() {
    const svgData = canvas.toSVG();
    const blob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'infographic.svg';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

// 导出为 PNG
function exportAsPNG() {
    const dataURL = canvas.toDataURL({
        format: 'png',
        quality: 1,
        multiplier: 2  // 2x 分辨率
    });
    const link = document.createElement('a');
    link.href = dataURL;
    link.download = 'infographic.png';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// 生成精修版 (使用 Gemini AI)
async function generateRefinedVersion() {
    try {
        // 显示加载提示
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'loading-overlay';
        loadingDiv.innerHTML = `
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <span id="refinement-status">正在使用 AI 精修信息图表...</span>
            </div>
        `;
        loadingDiv.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        `;
        document.body.appendChild(loadingDiv);

        // 使用现有的导出 PNG 功能获取 PNG base64 数据
        const pngDataURL = canvas.toDataURL({
            format: 'png',
            quality: 1,
            multiplier: 2  // 2x 分辨率
        });

        // 发送到后端进行处理
        const response = await fetch('/api/export_final', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                png_base64: pngDataURL
            })
        });

        const result = await response.json();

        if (result.status === 'started') {
            // 轮询检查状态
            await pollRefinementStatus(loadingDiv);
        } else {
            throw new Error(result.error || '生成失败');
        }

    } catch (error) {
        console.error('生成精修版失败:', error);
        alert('生成精修版失败: ' + error.message);

        // 移除加载提示
        const loadingDiv = document.querySelector('.loading-overlay');
        if (loadingDiv) {
            document.body.removeChild(loadingDiv);
        }
    }
}

// 轮询精修状态
async function pollRefinementStatus(loadingDiv) {
    const maxAttempts = 120; // 最多等待2分钟
    let attempts = 0;

    const statusText = document.getElementById('refinement-status');

    while (attempts < maxAttempts) {
        try {
            const response = await fetch('/api/status');
            const status = await response.json();

            // 更新状态文本
            if (status.progress && statusText) {
                statusText.textContent = "";
            }

            if (status.step === 'final_export' && status.completed) {
                if (status.status === 'completed') {
                    // 移除加载提示
                    document.body.removeChild(loadingDiv);

                    // 显示精修后的图片预览（内联显示在下方）
                    showRefinedImagePreview();

                    // 滚动到精修版预览区域
                    document.getElementById('refined-preview-section').scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });

                    return;
                } else if (status.status === 'error') {
                    throw new Error(status.progress || '精修失败');
                }
            }

        } catch (error) {
            console.error('检查状态失败:', error);
        }

        await new Promise(resolve => setTimeout(resolve, 1000));
        attempts++;
    }

    // 超时
    document.body.removeChild(loadingDiv);
    throw new Error('精修超时，请重试');
}

// 显示精修后的图片预览（内联显示）
async function showRefinedImagePreview() {
    const previewSection = document.getElementById('refined-preview-section');
    const imgPreview = document.getElementById('refinedImagePreview');
    const refPreview = document.getElementById('referenceImagePreview');

    // 设置图片源为后端提供的精修图片
    imgPreview.src = '/api/download_final?' + new Date().getTime(); // 添加时间戳防止缓存

    // 获取并显示参考图
    try {
        const response = await fetch('/api/status');
        const status = await response.json();
        const referenceImage = status.selected_reference;

        if (referenceImage) {
            // 使用相对路径或完整URL
            refPreview.src = '/' + referenceImage + '?' + new Date().getTime();
        } else {
            // 如果没有参考图，隐藏参考图容器
            refPreview.parentElement.style.display = 'none';
        }
    } catch (error) {
        console.error('获取参考图失败:', error);
        refPreview.parentElement.style.display = 'none';
    }

    // 显示预览区域
    previewSection.classList.add('show');
}

// 下载精修后的图片
function downloadRefinedImage() {
    const link = document.createElement('a');
    link.href = '/api/download_final';
    link.download = 'infographic_refined.jpg';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}


// 加载图表数据
async function loadChartData(chartType, data, title, pictogram) {
    if (!chartType || !data) {
        alert("请确保已选择数据源和图表类型");
        return;
    }

    // 显示加载状态
    const container = document.getElementById('canvas-container');
    const canvasEl = document.getElementById('fabricCanvas');
    canvasEl.style.display = 'none';

    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'loading';
    loadingDiv.innerHTML = '<div class="loading-spinner"></div><span>正在加载图表...</span>';
    container.appendChild(loadingDiv);

    try {
        const svgURL = `/authoring/chart?charttype=${encodeURIComponent(chartType)}&data=${encodeURIComponent(data)}&title=${encodeURIComponent(title)}&pictogram=${encodeURIComponent(pictogram)}`;

        const response = await fetch(svgURL);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const result = await response.json();
        const { chart, img1, img2, bg_color, layout } = result;

        // 清空画布
        canvas.clear();

        // 设置背景色
        if (bg_color) {
            updateBgColor(bg_color);
        } else {
            canvas.setBackgroundColor(currentBgColor, canvas.renderAll.bind(canvas));
        }

        // 如果有布局信息，使用布局信息来设置位置和大小
        let chartOptions, titleOptions, imageOptions;

        if (layout && layout.chart && layout.title && layout.image) {
            console.log('使用参考图布局信息:', layout);

            // 根据canvas的宽高和参考图的比例计算实际位置和大小
            chartOptions = {
                left: layout.chart.x * canvas.width,
                top: layout.chart.y * canvas.height,
                maxWidth: layout.chart.width * canvas.width,
                maxHeight: layout.chart.height * canvas.height
            };

            titleOptions = {
                left: layout.title.x * canvas.width,
                top: layout.title.y * canvas.height,
                maxWidth: layout.title.width * canvas.width,
                maxHeight: layout.title.height * canvas.height
            };

            imageOptions = {
                left: layout.image.x * canvas.width,
                top: layout.image.y * canvas.height,
                maxWidth: layout.image.width * canvas.width,
                maxHeight: layout.image.height * canvas.height
            };
        } else {
            // 使用默认布局
            console.log('使用默认布局');
            chartOptions = {
                maxWidth: canvas.width * 0.9,
                maxHeight: canvas.height * 0.7,
                left: canvas.width * 0.05,
                top: canvas.height * 0.15
            };

            titleOptions = {
                maxWidth: 400,
                maxHeight: 150,
                left: 20,
                top: 20
            };

            imageOptions = {
                maxWidth: 200,
                maxHeight: 200,
                left: canvas.width - 220,
                top: canvas.height - 220
            };
        }

        // 添加图表图片（现在是 PNG 而不是 SVG）
        if (chart) {
            await addImageToCanvas(chart, chartOptions);
        }

        // 添加图片1 (标题)
        if (img1) {
            await addImageToCanvas(img1, titleOptions);
        }

        // 添加图片2 (配图)
        if (img2) {
            await addImageToCanvas(img2, imageOptions);
        }

        // 保存初始状态到撤销栈
        setTimeout(() => {
            saveState();
        }, 100);

    } catch (err) {
        console.error("加载图表失败:", err);

        // 显示错误信息
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = `加载图表失败: ${err.message}`;
        container.appendChild(errorDiv);
    } finally {
        // 移除加载状态
        if (loadingDiv.parentNode) {
            loadingDiv.parentNode.removeChild(loadingDiv);
        }
        canvasEl.style.display = 'block';
    }
}

// 事件监听器
document.getElementById('aspectRatioSelector').addEventListener('change', function() {
    updateCanvasAspectRatio(this.value);
});

document.getElementById('bgColorPicker').addEventListener('input', function() {
    updateBgColor(this.value);
});

document.getElementById('bgColorText').addEventListener('input', function() {
    let value = this.value;
    if (!value.startsWith('#')) {
        value = '#' + value;
    }
    if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
        updateBgColor(value);
    }
});

document.getElementById('bgColorText').addEventListener('blur', function() {
    this.value = currentBgColor;
});

// 透明度控制
document.getElementById('opacitySlider').addEventListener('input', function() {
    const opacityPercent = this.value;
    const opacityValue = opacityPercent / 100;

    // 更新显示的透明度值
    document.getElementById('opacityValue').textContent = opacityPercent;

    // 获取当前选中的对象
    const activeObject = canvas.getActiveObject();
    if (activeObject) {
        // 设置选中对象的透明度
        activeObject.set('opacity', opacityValue);
        canvas.renderAll();
    }
});

// 更新透明度滑块的辅助函数
function updateOpacitySlider(obj) {
    if (obj) {
        const opacityPercent = Math.round((obj.opacity || 1) * 100);
        document.getElementById('opacitySlider').value = opacityPercent;
        document.getElementById('opacityValue').textContent = opacityPercent;
    }
}

// 初始化
window.addEventListener('DOMContentLoaded', () => {
    const initialChartType = "{{ charttype | safe }}";
    const initialData = "{{ data | safe }}";
    const initialTitle = "{{ title | safe }}";
    const initialPictogram = "{{ pictogram | safe }}";

    // 初始化画布（默认使用 3:4 比例）
    const config = aspectRatios['3:4'];
    initCanvas(config.width, config.height);

    // 初始化撤销/重做按钮状态
    updateUndoRedoButtons();

    // 加载数据
    if (initialChartType && initialData) {
        loadChartData(initialChartType, initialData, initialTitle, initialPictogram);
    }
});
    </script>
</body>
</html>
